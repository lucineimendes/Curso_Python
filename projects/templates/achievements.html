{% extends 'base.html' %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/achievements.css') }}">
{% endblock %}

{% block content %}
<div class="container py-5">
    <!-- Header Section -->
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-3 fw-bold text-gradient mb-3">üèÜ Minhas Conquistas</h1>
            <p class="text-muted lead fs-5">Acompanhe seu progresso e desbloqueie medalhas exclusivas!</p>
        </div>
    </div>

    <!-- Stats Section -->
    <div class="row mb-5">
        <div class="col-lg-8 col-xl-6 mx-auto">
            <div class="card bg-glass border-0 shadow-lg achievement-stats-card">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h4 class="mb-1 fw-bold">Progresso de Conquistas</h4>
                            <p class="text-muted small mb-0">Continue aprendendo para desbloquear mais!</p>
                        </div>
                        <span class="badge rounded-pill fs-5 px-4 py-2" id="achievement-counter">0 / 0</span>
                    </div>
                    <div class="progress" style="height: 24px;">
                        <div class="progress-bar animated" role="progressbar" style="width: 0%;" id="achievement-progress-bar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                            <span class="fw-semibold">0%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Grid -->
    <div id="achievements-grid">
        <!-- Achievements will be loaded here via JS -->
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                <span class="visually-hidden">Carregando...</span>
            </div>
            <p class="text-muted mt-3">Carregando conquistas...</p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', async () => {
    const grid = document.getElementById('achievements-grid');
    const counter = document.getElementById('achievement-counter');
    const progressBar = document.getElementById('achievement-progress-bar');

    try {
        const response = await fetch('/api/achievements');
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.message || 'Erro ao carregar conquistas');
        }

        const { unlocked, locked, stats } = data.achievements;
        const allAchievements = [...unlocked, ...locked];

        // Update stats
        counter.textContent = `${stats.unlocked} / ${stats.total}`;
        const percentage = Math.round(stats.percentage);
        progressBar.style.width = `${stats.percentage}%`;
        progressBar.querySelector('span').textContent = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);

        // Render achievements
        grid.innerHTML = allAchievements.map(ach => {
            const isUnlocked = ach.unlocked_at !== undefined;
            const unlockedDate = isUnlocked ? new Date(ach.unlocked_at).toLocaleDateString('pt-BR') : '';

            return `
                <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}" data-category="${ach.category || 'general'}" tabindex="0">
                    <div class="achievement-card-inner">
                        <div class="achievement-icon">
                            ${ach.icon}
                        </div>
                        <h5 class="achievement-title">${ach.name}</h5>
                        <p class="achievement-description">${ach.description}</p>
                        <div class="achievement-status mt-auto">
                            ${isUnlocked
                                ? `<span class="badge bg-success-subtle text-success rounded-pill">
                                    <i class="bi bi-check-circle-fill me-1"></i>
                                    Desbloqueado em ${unlockedDate}
                                   </span>`
                                : `<span class="badge bg-secondary-subtle text-secondary rounded-pill">
                                    <i class="bi bi-lock-fill me-1"></i>
                                    Bloqueado
                                   </span>`
                            }
                        </div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        console.error('Erro ao carregar conquistas:', error);
        grid.innerHTML = '<div class="alert alert-danger">Erro ao carregar conquistas. Tente recarregar a p√°gina.</div>';
    }
});
</script>
{% endblock %}
